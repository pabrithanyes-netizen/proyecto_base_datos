WITH total_por_cliente AS (
    SELECT
        c.id_cliente,
        c.nombre,
        c.apellido,
        c.correo,
       SUM(f.total) AS total_gastado
    FROM bpanchana.cliente c
    JOIN bpanchana.factura f
        ON c.id_cliente = f.id_cliente
    WHERE f.estado = 'PAGADA'
      AND f.activo = TRUE
    GROUP BY c.id_cliente, c.nombre, c.apellido, c.correo
)
SELECT
    nombre || ' ' || apellido AS nombre_completo,
    correo,
    total_gastado
FROM total_por_cliente
ORDER BY total_gastado DESC
LIMIT 5;
