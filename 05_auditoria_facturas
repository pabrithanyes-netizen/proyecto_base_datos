WITH suma_detalle AS (
    SELECT
        id_factura,
        SUM(subtotal_linea) AS total_detalle
    FROM bpanchana.detalle_factura
    WHERE activo = TRUE
    GROUP BY id_factura
)
SELECT
    f.id_factura,
    f.subtotal,
    f.impuesto,
    f.total,
    sd.total_detalle,
    (f.subtotal + f.impuesto - f.total) AS diferencia_total,
    (f.subtotal - sd.total_detalle) AS diferencia_detalle
FROM bpanchana.factura f
LEFT JOIN suma_detalle sd
    ON f.id_factura = sd.id_factura
WHERE f.estado = 'PAGADA'
  AND f.activo = TRUE
  AND (
        f.subtotal + f.impuesto <> f.total
        OR f.subtotal <> sd.total_detalle
      )
ORDER BY f.id_factura;
